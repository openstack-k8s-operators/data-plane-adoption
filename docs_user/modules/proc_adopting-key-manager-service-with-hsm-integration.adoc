:_mod-docs-content-type: PROCEDURE
[id="adopting-key-manager-service-with-hsm-integration_{context}"]

= Adopting the {key_manager} with HSM integration

[role="_abstract"]
When your source {OpenStackPreviousInstaller} environment includes Hardware Security Module (HSM) integration, you must use the HSM-enabled adoption approach to preserve HSM functionality and maintain access to HSM-backed secrets.

.Prerequisites

* Source {OpenStackPreviousInstaller} environment with HSM integration configured
* HSM client software and certificates available on the adoption environment
* Target {rhos_acro} environment with HSM infrastructure accessible
* HSM-enabled {key_manager} container images built and available in your registry
* Appropriate HSM secrets created in the target {rhos_acro} environment

.Procedure

. Check your source environment configuration to confirm HSM integration:
+
[source,bash]
----
$ ssh tripleo-admin@controller-0.ctlplane \
  "sudo cat /var/lib/config-data/puppet-generated/barbican/etc/barbican/barbican.conf | grep -A5 '\[.*plugin\]'"
----
+
If you see `[p11_crypto_plugin]` or other HSM-specific sections, continue with HSM adoption.

. Extract the simple crypto KEK from your source environment:
+
[source,bash]
----
$ SIMPLE_CRYPTO_KEK=$(ssh tripleo-admin@controller-0.ctlplane \
  "sudo python3 -c \"import configparser; c = configparser.ConfigParser(); c.read('/var/lib/config-data/puppet-generated/barbican/etc/barbican/barbican.conf'); print(c['simple_crypto_plugin']['kek'])\"")
----

. Add the KEK to the target environment:
+
[source,bash]
----
$ oc set data secret/osp-secret "BarbicanSimpleCryptoKEK=${SIMPLE_CRYPTO_KEK}"
----

. Create HSM-specific secrets in the target environment:
+
[source,bash]
----
# Create HSM login credentials secret
$ oc create secret generic hsm-login \
  --from-literal=password=<your_hsm_password>

# Create HSM client configuration and certificates secret
$ oc create secret generic hsm-client-data \
  --from-file=client.crt=<path_to_client_cert> \
  --from-file=client.key=<path_to_client_key> \
  --from-file=server.crt=<path_to_server_cert> \
  --from-file=hsm_config=<path_to_hsm_config>
----

. Patch the `OpenStackControlPlane` CR to deploy {key_manager} with HSM support:
+
[source,yaml]
----
$ oc patch openstackcontrolplane openstack --type=merge --patch '
spec:
  barbican:
    enabled: true
    apiOverride:
      route: {}
    template:
      databaseInstance: openstack
      databaseAccount: barbican
      rabbitMqClusterName: rabbitmq
      secret: osp-secret
      simpleCryptoBackendSecret: osp-secret
      serviceAccount: barbican
      serviceUser: barbican
      passwordSelectors:
        database: BarbicanDatabasePassword
        service: BarbicanPassword
        simplecryptokek: BarbicanSimpleCryptoKEK
      customServiceConfig: |
        [DEFAULT]
        debug = False

        [simple_crypto_plugin]
        kek = change_me

        [p11_crypto_plugin]
        plugin_name = PKCS11
        library_path = /opt/hsm/lib/libhsm.so
        token_labels = HSM_TOKEN_1
        mkek_label = adoption_mkek_1
        hmac_label = adoption_hmac_1
        encryption_mechanism = CKM_AES_CBC
        hmac_key_type = CKK_GENERIC_SECRET
        hmac_keygen_mechanism = CKM_GENERIC_SECRET_KEY_GEN
        hmac_mechanism = CKM_SHA256_HMAC
        key_wrap_mechanism = CKM_AES_CBC_PAD
        key_wrap_generate_iv = true
        always_set_cka_sensitive = true
        os_locking_ok = false
        login = change_me
      globalDefaultSecretStore: pkcs11
      enabledSecretStores:
        - simple_crypto
        - pkcs11
      pkcs11:
        loginSecret: hsm-login
        clientDataSecret: hsm-client-data
        clientDataPath: /etc/hsm
      barbicanAPI:
        replicas: 1
        override:
          service:
            internal:
              metadata:
                annotations:
                  metallb.universe.tf/address-pool: internalapi
                  metallb.universe.tf/allow-shared-ip: internalapi
                  metallb.universe.tf/loadBalancerIPs: 172.17.0.80
              spec:
                type: LoadBalancer
      barbicanWorker:
        replicas: 1
      barbicanKeystoneListener:
        replicas: 1
'
----
+
[IMPORTANT]
====
Replace the `change_me` values with your actual HSM configuration. The exact parameters depend on your HSM vendor and configuration.
====

.Verification

. Verify that both secret stores are available:
+
[source,bash]
----
$ openstack secret store list
----

. Test HSM backend functionality:
+
[source,bash]
----
$ openstack secret store --name "hsm-test-$(date +%s)" \
  --payload "test-payload" \
  --algorithm aes --mode cbc --bit-length 256
----

. Verify migrated secrets are accessible:
+
[source,bash]
----
$ openstack secret list
----

. Check that the {key_manager} services are operational:
+
[source,bash]
----
$ oc get pods -l service=barbican
----

[NOTE]
====
HSM adoption preserves both simple crypto and HSM-backed secrets. The migration process maintains HSM metadata and secret references, ensuring continued access to existing secrets while enabling new secrets to use either backend.
====
