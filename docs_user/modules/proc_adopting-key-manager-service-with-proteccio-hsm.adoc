:_mod-docs-content-type: PROCEDURE
[id="adopting-the-key-manager-service-with-proteccio-hsm_{context}"]

= Adopting the {key_manager} with Proteccio HSM integration

[role="_abstract"]
To adopt the {key_manager_first_ref} with Proteccio Hardware Security Module (HSM) integration, you use the enhanced Barbican adoption role with HSM support enabled through a configuration flag. This approach preserves HSM integration while adopting all existing secrets from your source {rhos_prev_long} ({OpenStackShort}) environment.

The {key_manager} Proteccio HSM adoption is complete if you see the following results:

* The `BarbicanAPI` and `BarbicanWorker` services are up and running with HSM-enabled configuration.
* All secrets from the source {OpenStackShort} {rhos_prev_ver} environment are available in {rhos_long} {rhos_curr_ver}.
* The PKCS11 crypto plugin is available alongside `simple_crypto` for new secret storage.
* HSM functionality is verified and operational.

[NOTE]
====
This procedure is specifically for environments that use Proteccio HSM. For standard {key_manager} adoption using `simple_crypto`, see xref:adopting-the-key-manager-service_{context}[Adopting the {key_manager}].

The enhanced Barbican adoption role supports HSM configuration through a simple boolean flag. This approach integrates seamlessly with the standard data-plane-adoption framework while providing HSM support.
====

.Prerequisites

* You have a running {OpenStackPreviousInstaller} environment with Proteccio HSM integration (the source cloud).
* You have a Single Node OpenShift or OpenShift Local running in the {rhocp_long} cluster.
* You have SSH access to the source {OpenStackPreviousInstaller} undercloud and controller nodes.
* You have configured HSM variables in your adoption configuration files.
* Custom Barbican container images with the Proteccio client libraries are available in your registry.

[IMPORTANT]
====
The HSM adoption process requires proper configuration of HSM-related variables. The adoption role automatically creates the required Kubernetes secrets (`hsm-login` and `proteccio-data`) when `barbican_hsm_enabled` is set to `true`. Ensure that:

* All HSM-related variables are properly set in your configuration files
* The Proteccio client ISO, certificates, and configuration files are accessible from the configured URLs
* Custom Barbican images with Proteccio client are built and available in your container registry

Without proper HSM configuration, your HSM-protected secrets will become inaccessible after adoption.
====

.Procedure

. Configure HSM integration variables in your adoption configuration (Zuul job vars or CI framework configuration):
+
----
# Enable HSM integration for the Barbican adoption role
barbican_hsm_enabled: true

# HSM login credentials
proteccio_login_password: "your_hsm_password"

# Kubernetes secret names (defaults shown)
proteccio_login_secret_name: "hsm-login"
proteccio_client_data_secret_name: "proteccio-data"

# HSM partition and key configuration
cifmw_barbican_proteccio_partition: "VHSM1"
cifmw_barbican_proteccio_mkek_label: "adoption_mkek_1"
cifmw_barbican_proteccio_hmac_label: "adoption_hmac_1"
cifmw_barbican_proteccio_library_path: "/usr/lib64/libnethsm.so"
cifmw_barbican_proteccio_key_wrap_mechanism: "CKM_AES_CBC_PAD"

# HSM client sources (URLs to download Proteccio client files)
cifmw_hsm_proteccio_client_src: "https://your-server/path/to/Proteccio3.06.05.iso"
cifmw_hsm_proteccio_conf_src: "https://your-server/path/to/proteccio.rc"
cifmw_hsm_proteccio_client_crt_src: "https://your-server/path/to/client.crt"
cifmw_hsm_proteccio_client_key_src: "https://your-server/path/to/client.key"
cifmw_hsm_proteccio_server_crt_src:
  - "https://your-server/path/to/hsm_server.CRT"
----

. Run the data-plane-adoption tests with HSM support enabled. The adoption process will:
+
--
* Extract the simple crypto KEK from the source configuration
* Create the required HSM secrets (`hsm-login` and `proteccio-data`) in the target namespace
* Deploy Barbican with HSM-enabled configuration using the PKCS#11 plugin
* Verify HSM functionality and secret migration
--

.Verification

. Ensure that the {identity_service_first_ref} endpoints are defined and are pointing to the control plane FQDNs:
+
----
$ openstack endpoint list | grep key-manager
----

. Ensure that Barbican API service is registered in the {identity_service}:
+
----
$ openstack service list | grep key-manager
----

. Verify that all secrets from the source environment are available:
+
----
$ openstack secret list
----

. Confirm that Barbican services are running:
+
----
$ oc get pods -n openstack -l service=barbican -o wide
----

. Test secret creation to verify HSM functionality:
+
----
$ openstack secret store --name adoption-verification --payload 'HSM adoption successful'
----

. Verify HSM backend is operational:
+
----
$ openstack secret get <secret-id> --payload
----

.Additional resources

* For troubleshooting adoption issues, check the Ansible playbook logs and OpenShift events.
* To switch the default secret store from `simple_crypto` to `pkcs11` after verifying HSM connectivity:
+
----
$ oc patch openstackcontrolplane openstack -n openstack --type='json' -p='[{"op": "replace", "path": "/spec/barbican/template/globalDefaultSecretStore", "value": "pkcs11"}]'
----
