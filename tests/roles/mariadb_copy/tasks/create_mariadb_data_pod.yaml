  # This allows the recreated pod in a new ns reuse the same pv
- name: remove mariadb data pod before recreating
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    oc delete pod -n {{ org_namespace }} mariadb-copy-data --ignore-not-found=true
  when: recreate_pod | default(false) | bool

- name: start an adoption mariadb helper pod
  ansible.builtin.shell: |-
    {{ shell_header }}
    {{ oc_header }}
    {{ mariadb_copy_shell_vars_src }}

    oc apply -f - <<EOF
    ---
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: mariadb-data
      namespace: {{ namespace }}
    spec:
      storageClassName: $STORAGE_CLASS
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: mariadb-copy-data
      annotations:
        openshift.io/scc: anyuid
        k8s.v1.cni.cncf.io/networks: {{ custom_networks }}
      namespace: {{ namespace| default('openstack') }}
      labels:
        app: adoption
    spec:
      {{ custom_spec|default('') }}
      containers:
      - image: $MARIADB_IMAGE
        command: [ "sh", "-c", "sleep infinity"]
        name: adoption
        volumeMounts:
        - mountPath: /backup
          name: mariadb-data
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop: ALL
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      volumes:
      - name: mariadb-data
        persistentVolumeClaim:
          claimName: mariadb-data

    EOF

  changed_when: true
  notify: delete adoption mariadb helper pod and pvc

  # In case of OSPdO src ,helps spin up a pod on the osp18 NS,
  # while previously on ospdo
- name: start an adoption mariadb helper pod
  ansible.builtin.shell: |-
    {{ shell_header }}
    {{ oc_header }}
    {{ mariadb_copy_shell_vars_src }}

    oc apply -f - <<EOF
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: mariadb-copy-data
      annotations:
        openshift.io/scc: anyuid
        k8s.v1.cni.cncf.io/networks: {{ custom_networks_osp18 }}
      namespace: {{ namespace| default('openstack') }}
      labels:
        app: adoption
    spec:
      {{ custom_spec|default('') }}
      containers:
      - image: $MARIADB_IMAGE
        command: [ "sh", "-c", "sleep infinity"]
        name: adoption
        volumeMounts:
        - mountPath: /backup
          name: mariadb-data
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop: ALL
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      volumes:
      - name: mariadb-data
        persistentVolumeClaim:
          claimName: mariadb-data

    EOF

  changed_when: true
  notify: delete adoption mariadb helper pod and pvc
  when:
    - ospdo_src| bool
    - restore_db_pod| default('false')| bool


- name: wait for the pod to come up
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    oc wait --for condition=Ready -n {{ namespace| default('openstack') }} pod/mariadb-copy-data --timeout=10s
  register: mariadb_data_pod_result
  until: mariadb_data_pod_result is success
  retries: 25
  delay: 2
