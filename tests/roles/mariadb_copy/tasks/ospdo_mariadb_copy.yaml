
- name: set OSPdO env vars
  block:
  - name: register source_mariadb_ip
    no_log: "{{ use_no_log }}"
    delegate_to: "{{ adoption_ospdo_host }}"
    ansible.builtin.shell: |
      {{ controller1_ssh }} sudo cat /var/lib/config-data/puppet-generated/haproxy/etc/haproxy/haproxy.cfg | grep -A1 'listen mysql'|tail -n 1|sed 's/.*bind //g' |sed 's/:3306.*//g'
    register: source_mariadb_ip

  - name: register source_db_root_pass
    no_log: "{{ use_no_log }}"
    delegate_to: "{{ adoption_ospdo_host }}"
    ansible.builtin.shell: |
      oc get secret tripleo-passwords -o jsonpath='{.data.*}'| base64 -d |grep MysqlRootPassword|sed 's/.*: //g'
    register: source_db_root_pass

  - name: set src MariaDB copy shell vars
    no_log: "{{ use_no_log }}"
    ansible.builtin.set_fact:
      mariadb_copy_shell_vars_src: |
        MARIADB_IMAGE=quay.io/podified-antelope-centos9/openstack-mariadb:current-podified
        # TODO: remove the default(external_...) when CI is transitioned to use 'source_...'
        SOURCE_MARIADB_IP={{ source_mariadb_ip }}
        declare -A SOURCE_GALERA_MEMBERS
        SOURCE_GALERA_MEMBERS=(
        ["standalone.localdomain"]=$SOURCE_MARIADB_IP-
        # ...
        )
        SOURCE_DB_ROOT_PASSWORD={{ source_db_root_pass.stdout }}
  when: env_vars_ospdo| default(false) | bool

- name: ospdo pre tasks
  block:
  - name: get mysql adoption scripts to all controllers
    delegate_to: "{{ adoption_ospdo_host }}"
    ansible.builtin.shell: |
      {{ item }} git clone {{ dpa_repo }}
    ignore_errors: true
    loop: "{{ osp_controllers_ssh }}"

  - name: check that the Galera database cluster members are online and synced
    delegate_to: "{{ adoption_ospdo_host }}"
    shell: |
      {{ item }} {{ dpa_mysql_script }} check_wsrep | grep -qE '\bSynced\b'
    loop: "{{ osp_controllers_ssh }}"
  when: db_pre_tasks| default(false) | bool

- name: ospdo get mariadb DBs
  block  :
    #The following setup and execute the db extarction
  - name: set mariadb_copy_tmp_dir var
    set_fact:
      mariadb_copy_tmp_dir: /tmp/mariadb

  - name: run get dbs script on galera container
    delegate_to: "{{ adoption_ospdo_host }}"
    ansible.builtin.shell: |

        {{ controller1_ssh }} "export ospdo_src=true;{{ dpa_templates }}/dump_dbs.bash"

  # Copy DB dumps to local tmp
  - name: Copy DB dumps ctrl0 to openstackclient
    delegate_to: "{{ adoption_ospdo_host }}"
    ansible.builtin.shell: |
        {{ exec_ospdoclnt_pod }} -- bash -c "rsync -a controller-0.ctlplane:/tmp/mariadb /tmp"

  - name: Copy DB dumps openstackclient to BM
    delegate_to: "{{ adoption_ospdo_host }}"
    ansible.builtin.shell: |
      oc cp openstack/openstackclient:/tmp/mariadb/ /tmp/mariadb

  - name: Copy DB dumps BM to local
    ansible.builtin.shell: |
        scp -r root@{{ adoption_ospdo_host }}:/tmp/mariadb /tmp

  - name: Show DB dumps on local
    ansible.builtin.shell: |
        ls /tmp/mariadb/
  when: ospdo_get_dbs| default(false) | bool
