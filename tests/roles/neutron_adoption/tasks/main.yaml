- name: Fix neutron alembic expand version
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    DB_ROOT_PASSWORD=$(oc get secret osp-secret -n openstack -o jsonpath='{.data.DbRootPassword}' | base64 -d)
    sleep 5
    OLD_VERSION=$(oc exec openstack-galera-0 -n openstack -- \
      mysql -u root -p"${DB_ROOT_PASSWORD}" neutron -N -s -e \
      "SELECT version_num FROM alembic_version WHERE version_num='8df53b0d2c0e';" 2>/dev/null || true)
    if [ -n "$OLD_VERSION" ]; then
      echo "Updating alembic version: 8df53b0d2c0e -> fc153938cdc1"
      oc exec openstack-galera-0 -n openstack -- \
        mysql -u root -p"${DB_ROOT_PASSWORD}" neutron -e \
        "UPDATE alembic_version SET version_num='fc153938cdc1' WHERE version_num='8df53b0d2c0e';"
    fi
  register: alembic_fix_result
  changed_when: "'Updating alembic version' in alembic_fix_result.stdout"

- name: deploy podified Neutron
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    oc patch openstackcontrolplane openstack --type=merge --patch '{{ neutron_config_patch }}'

- name: wait for Neutron to start up
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    oc wait pod --for condition=Ready --selector=service=neutron
  register: neutron_running_result
  until: neutron_running_result is success
  retries: 60
  delay: "{{ neutron_retry_delay }}"

- name: check that Neutron is reachable and its endpoints are defined
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    alias openstack="oc exec -t openstackclient -- openstack"

    ${BASH_ALIASES[openstack]} endpoint list | grep network
    ${BASH_ALIASES[openstack]} network list
  register: neutron_responding_result
  until: neutron_responding_result is success
  retries: 15
  delay: "{{ neutron_retry_delay }}"
