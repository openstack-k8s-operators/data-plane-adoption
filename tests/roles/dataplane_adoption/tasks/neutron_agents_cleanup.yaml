# These tasks will delete agents that where not adopted, but replaced by
# either a new service or a new agent running on a different host post
# adoption.

- name: delete agent type dhcp
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    alias openstack="oc exec -t openstackclient -- openstack"

    AGENT_ID=$(${BASH_ALIASES[openstack]} network agent list --agent-type dhcp --host {{ item }} -f value -c ID)
    if [ -n "${AGENT_ID}" ]; then
      ${BASH_ALIASES[openstack]} network agent delete ${AGENT_ID}
    fi
  loop: "{{ neutron_dhcp_agent_cleanup_hosts | default([]) }}"

- name: delete OVN Gateway agents
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    alias openstack="oc exec -t openstackclient -- openstack"

    AGENT_ID=$(${BASH_ALIASES[openstack]} network agent list --agent-type ovn-controller-gateway --host {{ item }} -f value -c ID)
    if [ -n "${AGENT_ID}" ]; then
      ${BASH_ALIASES[openstack]} network agent delete ${AGENT_ID}
    fi
  loop: "{{ neutron_ovn_controller_gateway_agent_cleanup_hosts | default([]) }}"

- name: delete stale OVN Metadata agents from TripleO
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    alias openstack="oc exec -t openstackclient -- openstack"

    # Delete metadata agents that are not alive (stopped during TripleO cleanup)
    # This handles cases where the new EDPM deployment creates new agent records
    # instead of reusing the old TripleO ones (different hostnames/chassis IDs)
    for AGENT_ID in $(${BASH_ALIASES[openstack]} network agent list | grep 'neutron-ovn-metadata-agent' | grep 'XXX' | awk '{print $2}'); do
      echo "Deleting stale metadata agent: ${AGENT_ID}"
      ${BASH_ALIASES[openstack]} network agent delete ${AGENT_ID} || true
    done

- name: delete stale OVN Controller agents from TripleO
  ansible.builtin.shell: |
    {{ shell_header }}
    {{ oc_header }}
    alias openstack="oc exec -t openstackclient -- openstack"

    # Delete OVN controller agents that are not alive (stopped during TripleO cleanup)
    # This handles cases where the new EDPM deployment creates new agent records
    # instead of reusing the old TripleO ones (different hostnames/chassis IDs)
    # Note: grep -v 'Gateway' excludes OVN Controller Gateway agents which are
    # handled by the dedicated task above
    for AGENT_ID in $(${BASH_ALIASES[openstack]} network agent list | grep 'OVN Controller agent' | grep -v 'Gateway' | grep 'XXX' | awk '{print $2}'); do
      echo "Deleting stale OVN controller agent: ${AGENT_ID}"
      ${BASH_ALIASES[openstack]} network agent delete ${AGENT_ID} || true
    done
