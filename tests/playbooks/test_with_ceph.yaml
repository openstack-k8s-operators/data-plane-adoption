- name: Common pre-adoption tasks
  import_playbook: _before_adoption.yaml

- name: Optimized Adoption with Ceph - Improved Service Ordering
  hosts: local
  gather_facts: false
  vars:
    glance_backend: ceph
    manila_backend: cephfs
    cinder_volume_backend: ceph
    cinder_backup_backend: ceph
    nova_libvirt_backend: ceph
  module_defaults:
    ansible.builtin.shell:
      executable: /bin/bash

  # Sequential foundation roles (cannot be parallelized)
  roles:
    - role: development_environment
      tags: [development_environment]
    - role: tls_adoption
      tags: [tls_adoption]
      when: enable_tlse|default(false)
    - role: backend_services
      tags: [backend_services]
    - role: ceph_backend_configuration
      tags: [ceph_backend_configuration]
    - role: get_services_configuration
      tags: [get_services_configuration]
    - role: stop_openstack_services
      tags: [stop_openstack_services]
    - role: mariadb_copy
      tags: [mariadb_copy]
    - role: ovn_adoption
      tags: [ovn_adoption]
    - role: keystone_adoption
      tags: [keystone_adoption]

    # Group 1: Services that only depend on Keystone (run together)
    - role: barbican_adoption
      tags: [barbican_adoption, group1]
    - role: swift_adoption
      tags: [swift_adoption, group1]
    - role: horizon_adoption
      tags: [horizon_adoption, group1]
    - role: heat_adoption
      tags: [heat_adoption, group1]
    - role: telemetry_adoption
      tags: [telemetry_adoption, group1]
      when: telemetry_adoption|default(true)

    # Sequential: Neutron (required for networking services)
    - role: neutron_adoption
      tags: [neutron_adoption]

    # Group 2: Services that depend on Neutron (run together)
    - role: glance_adoption
      tags: [glance_adoption, group2]
    - role: placement_adoption
      tags: [placement_adoption, group2]

    # Group 3: Services that depend on Placement/Glance (run together)
    - role: nova_adoption
      tags: [nova_adoption, group3]
    - role: cinder_adoption
      tags: [cinder_adoption, group3]
    - role: octavia_adoption
      tags: [octavia_adoption, group3]
    - role: manila_adoption
      tags: [manila_adoption, group3]

    # Sequential: Autoscaling (depends on Telemetry)
    - role: autoscaling_adoption
      tags: [autoscaling_adoption]
      when: telemetry_adoption|default(true)

    # Sequential cleanup roles (cannot be parallelized)
    - role: stop_remaining_services
      tags: [stop_remaining_services]
    - role: pull_openstack_configuration
      tags: [pull_openstack_configuration]
    - role: dataplane_adoption
      tags: [dataplane_adoption]

- name: Stop the ping test
  import_playbook: _stop_ping_test.yaml
